name: Release on version file change

on:
  push:
    branches: [ main ]
    paths:
      - 'WORKFLOW_VERSION'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git config user.name "${{ github.actor }}"

      - name: Detect changed version file
        id: detect
        run: |
          CHANGED=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} || true)
          echo "changed=$CHANGED"
          WORKFLOW_CHANGED=false
          for f in $CHANGED; do
            if [[ "$f" == "WORKFLOW_VERSION" ]]; then
              WORKFLOW_CHANGED=true
            fi
          done
          echo "workflow_changed=$WORKFLOW_CHANGED" >> $GITHUB_OUTPUT

      - name: Create release from workflow version file
        if: ${{ steps.detect.outputs.workflow_changed == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git fetch --tags
          # Read workflow version and create tag+release
          file="WORKFLOW_VERSION"
          if [ ! -f "$file" ]; then
            echo "File $file not found, skipping"
            exit 0
          fi
          ver=$(cat "$file" | head -n1 | tr -d ' \t\n\r')
          if [ -z "$ver" ]; then
            echo "Version in $file is empty, skipping"
            exit 0
          fi
          tag="v${ver}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "$tag already exists, skipping"
            exit 0
          fi
          echo "Creating tag $tag"
          git tag -a "$tag" -m "Release $tag (from $file)"
          git push origin "$tag"

          echo "Creating GitHub release for $tag"
          gh_release_payload=$(jq -n --arg tag "$tag" --arg name "$tag" --arg body "Release $tag created from $file in $GITHUB_REPOSITORY" '{tag_name: $tag, name: $name, body: $body, draft: false, prerelease: false}')
          api_url="https://api.github.com/repos/${GITHUB_REPOSITORY}/releases"
          response=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" -H "Content-Type: application/json" -d "$gh_release_payload" "$api_url")
          echo "$response"
